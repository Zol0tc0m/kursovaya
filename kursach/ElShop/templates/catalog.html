{% extends "base.html" %}
{% block title %}–ö–∞—Ç–∞–ª–æ–≥{% endblock %}

{% block content %}
<style>
  /* üåó –û–±—â–∞—è —Ç—ë–º–Ω–∞—è —Ç–µ–º–∞ */
  [data-theme="dark"] body {
      background-color: #121212;
      color: #f5f5f5;
  }

  [data-theme="dark"] h1, 
  [data-theme="dark"] h2, 
  [data-theme="dark"] h3, 
  [data-theme="dark"] h4, 
  [data-theme="dark"] h5, 
  [data-theme="dark"] h6, 
  [data-theme="dark"] p,
  [data-theme="dark"] label,
  [data-theme="dark"] span,
  [data-theme="dark"] a {
      color: #f5f5f5 !important;
  }

  /* üåó –ö–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ */
  [data-theme="dark"] .card {
      background-color: #1e1e1e;
      color: #f5f5f5;
      border: 1px solid #333;
  }

  [data-theme="dark"] .card .card-title a {
      color: #fff !important;
  }

  [data-theme="dark"] .card .card-text {
      color: #80e27e !important;
  }

  /* üåó –ü–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
  .offcanvas.filter-panel {
      background-color: #ffffff;
      color: #000000;
      transition: background-color 0.3s, color 0.3s;
  }

  [data-theme="dark"] .offcanvas.filter-panel {
      background-color: #1e1e1e;
      color: #f5f5f5;
  }

  [data-theme="dark"] .offcanvas.filter-panel .offcanvas-header {
      border-bottom: 1px solid #333;
  }

  [data-theme="dark"] .offcanvas.filter-panel .form-label {
      color: #ddd;
  }

  [data-theme="dark"] .offcanvas.filter-panel .form-control,
  [data-theme="dark"] .offcanvas.filter-panel .form-select {
      background-color: #2b2b2b;
      color: #f5f5f5;
      border-color: #444;
  }

  [data-theme="dark"] .offcanvas.filter-panel .form-control:focus,
  [data-theme="dark"] .offcanvas.filter-panel .form-select:focus {
      background-color: #333;
      border-color: #666;
      color: #fff;
  }

  [data-theme="dark"] .offcanvas.filter-panel .btn-close {
      filter: invert(1);
  }

  [data-theme="dark"] .offcanvas.filter-panel .btn-success {
      background-color: #2e7d32;
      border-color: #256628;
      color: #fff;
  }

  [data-theme="dark"] .offcanvas.filter-panel .btn-success:hover {
      background-color: #388e3c;
  }

  /* üåó –ö–Ω–æ–ø–∫–∏ */
  [data-theme="dark"] .btn-primary {
      background-color: #1976d2;
      border-color: #115293;
  }

  [data-theme="dark"] .btn-primary:hover {
      background-color: #2196f3;
  }

  [data-theme="dark"] .btn-success {
      background-color: #2e7d32;
      border-color: #256628;
  }

  [data-theme="dark"] .btn-success:hover {
      background-color: #388e3c;
  }

  [data-theme="dark"] .page-link {
      background-color: #1e1e1e;
      color: #fff;
      border-color: #444;
  }

  [data-theme="dark"] .page-item.disabled .page-link {
      background-color: #2c2c2c;
      color: #aaa;
  }
</style>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤</h2>

    <!-- –ö–Ω–æ–ø–∫–∞ –≤—ã–∑–æ–≤–∞ –ø–∞–Ω–µ–ª–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
    <button class="btn btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#filterPanel" aria-controls="filterPanel">
        ‚öôÔ∏è –§–∏–ª—å—Ç—Ä—ã
    </button>

    {% if user.is_staff or user.groups.all.0.name == 'Manager' %}
    <div class="mb-3">
        <a href="{% url 'export_products' %}" class="btn btn-success">‚¨á –≠–∫—Å–ø–æ—Ä—Ç CSV</a>
        <form method="post" action="{% url 'import_products' %}" enctype="multipart/form-data" style="display:inline-block;">
            {% csrf_token %}
            <label for="csv_file" class="btn btn-primary mb-0">‚¨Ü –ò–º–ø–æ—Ä—Ç CSV</label>
            <input type="file" name="csv_file" id="csv_file" style="display:none;" onchange="this.form.submit();">
        </form>
    </div>
    {% endif %}
</div>

<!-- Offcanvas —Ñ–∏–ª—å—Ç—Ä—ã -->
<div class="offcanvas offcanvas-end filter-panel" tabindex="-1" id="filterPanel" aria-labelledby="filterPanelLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="filterPanelLabel">–§–∏–ª—å—Ç—Ä—ã</h5>
    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <form method="get" id="filterForm">
        <div class="mb-3">
            <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
            <select class="form-select" name="category" id="categorySelect">
                <option value="">–í—Å–µ</option>
                {% for cat in categories %}
                    <option value="{{ cat.id }}" {% if selected_category|add:'' == cat.id|stringformat:"s" %}selected{% endif %}>{{ cat.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="mb-3">
            <label class="form-label">–ú–∏–Ω. —Ü–µ–Ω–∞</label>
            <input type="number" class="form-control" step="0.01" name="min_price" value="{{ min_price }}" id="minPrice">
        </div>
        <div class="mb-3">
            <label class="form-label">–ú–∞–∫—Å. —Ü–µ–Ω–∞</label>
            <input type="number" class="form-control" step="0.01" name="max_price" value="{{ max_price }}" id="maxPrice">
        </div>
        <button type="submit" class="btn btn-success w-100">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
    </form>
  </div>
</div>

<!-- –°–µ—Ç–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ -->
<div class="row row-cols-1 row-cols-md-3 g-4">
    {% for product in products %}
        <div class="col">
            <div class="card h-100 product-card shadow-sm">
                {% if product.image %}
                    <img src="{{ product.image.url }}" class="card-img-top" alt="{{ product.name }}">
                {% else %}
                    <img src="https://via.placeholder.com/300x200?text={{ product.name|urlencode }}" class="card-img-top" alt="{{ product.name }}">
                {% endif %}
                <div class="card-body">
                    <h5 class="card-title">
                        <a href="{% url 'product_detail' product.id %}" class="text-decoration-none">
                            {{ product.name }}
                        </a>
                    </h5>
                    <p class="card-text fw-bold text-success">{{ product.base_price|floatformat:2 }} ‚Ç¨</p>
                    <form method="post" action="{% url 'add_to_cart' product.id %}">
                        {% csrf_token %}
                        <button class="btn btn-primary w-100">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</button>
                    </form>
                </div>
            </div>
        </div>
    {% empty %}
        <p>–¢–æ–≤–∞—Ä—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.</p>
    {% endfor %}
</div>

<!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
<nav class="mt-4">
    <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if min_price %}&min_price={{ min_price }}{% endif %}{% if max_price %}&max_price={{ max_price }}{% endif %}">¬´ –ù–∞–∑–∞–¥</a>
            </li>
        {% endif %}
        <li class="page-item disabled"><span class="page-link">–°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ page_obj.number }} –∏–∑ {{ page_obj.paginator.num_pages }}</span></li>
        {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if min_price %}&min_price={{ min_price }}{% endif %}{% if max_price %}&max_price={{ max_price }}{% endif %}">–í–ø–µ—Ä–µ–¥ ¬ª</a>
            </li>
        {% endif %}
    </ul>
</nav>

<!-- –°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–∑–∞–∫—Ä—ã—Ç–∏—è Offcanvas -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const filterForm = document.getElementById("filterForm");
    const offcanvasElement = document.getElementById("filterPanel");
    const offcanvas = bootstrap.Offcanvas.getOrCreateInstance(offcanvasElement);

    filterForm.addEventListener("submit", function() {
        offcanvas.hide();
    });
});
</script>
{% endblock %}